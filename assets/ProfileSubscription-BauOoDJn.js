import{r as h,j as e,f as Q,P as q,t as Z,s as b,y as Y,u as ee,F as L,G as T,J as M,K as $,O as D,B as f}from"./index-DBMRuhZV.js";import{D as te,l as se,f as ae,g as re,i as le,T as ie,a as ne,b as E,e as m,c as de,d as g}from"./dialog-DdAURfyz.js";import{u as N}from"./useQuery-B4ix4t-Z.js";var y="Progress",C=100,[oe]=Q(y),[ce,ue]=oe(y),O=h.forwardRef((t,a)=>{const{__scopeProgress:r,value:i=null,max:l,getValueLabel:p=xe,...c}=t;(l||l===0)&&!R(l)&&console.error(me(`${l}`,"Progress"));const s=R(l)?l:C;i!==null&&!V(i,s)&&console.error(ge(`${i}`,"Progress"));const o=V(i,s)?i:null,d=v(o)?p(o,s):void 0;return e.jsx(ce,{scope:r,value:o,max:s,children:e.jsx(q.div,{"aria-valuemax":s,"aria-valuemin":0,"aria-valuenow":v(o)?o:void 0,"aria-valuetext":d,role:"progressbar","data-state":k(o,s),"data-value":o??void 0,"data-max":s,...c,ref:a})})});O.displayName=y;var A="ProgressIndicator",B=h.forwardRef((t,a)=>{const{__scopeProgress:r,...i}=t,l=ue(A,r);return e.jsx(q.div,{"data-state":k(l.value,l.max),"data-value":l.value??void 0,"data-max":l.max,...i,ref:a})});B.displayName=A;function xe(t,a){return`${Math.round(t/a*100)}%`}function k(t,a){return t==null?"indeterminate":t===a?"complete":"loading"}function v(t){return typeof t=="number"}function R(t){return v(t)&&!isNaN(t)&&t>0}function V(t,a){return v(t)&&!isNaN(t)&&t<=a&&t>=0}function me(t,a){return`Invalid prop \`max\` of value \`${t}\` supplied to \`${a}\`. Only numbers greater than 0 are valid max values. Defaulting to \`${C}\`.`}function ge(t,a){return`Invalid prop \`value\` of value \`${t}\` supplied to \`${a}\`. The \`value\` prop must be:
  - a positive number
  - less than the value passed to \`max\` (or ${C} if no \`max\` prop is set)
  - \`null\` or \`undefined\` if the progress is indeterminate.

Defaulting to \`null\`.`}var G=O,he=B;const W=h.forwardRef(({className:t,value:a,...r},i)=>e.jsx(G,{ref:i,className:Z("relative h-4 w-full overflow-hidden rounded-full bg-secondary",t),...r,children:e.jsx(he,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(a||0)}%)`}})}));W.displayName=G.displayName;function pe(t){return N({queryKey:["userSubscription",t],queryFn:async()=>{if(!t)return null;const{data:a,error:r}=await b.from("v_my_subscription").select("*").maybeSingle();if(r)throw r;return a},enabled:!!t,staleTime:0,refetchOnMount:"always",refetchOnWindowFocus:"always"})}function fe(t){return N({queryKey:["creditWallet",t],queryFn:async()=>{if(!t)return null;const{data:a,error:r}=await b.from("credit_wallets").select("*").eq("user_id",t).maybeSingle();if(r)throw r;return a??null},enabled:!!t,staleTime:0,refetchOnMount:"always",refetchOnWindowFocus:"always"})}function je(t,a=0,r=20,i=!0){return N({queryKey:["creditLedger",t,a,r],queryFn:async()=>{if(!t)return{entries:[],totalCount:0};const l=a*r,p=l+r-1,[c,s]=await Promise.all([b.from("credit_ledger").select("*").eq("user_id",t).order("created_at",{ascending:!1}).range(l,p),b.from("credit_ledger").select("id",{count:"exact",head:!0}).eq("user_id",t)]);if(c.error)throw c.error;if(s.error)throw s.error;const o=c.data??[],d=s.count??o.length;return{entries:o,totalCount:d}},keepPreviousData:!0,enabled:i&&!!t})}const F=20;function j(t){if(!t)return"—";try{return new Date(t).toLocaleString()}catch{return t}}function ye(){const{t}=Y(["billing","common","profile"]),{session:a}=ee(),[r,i]=h.useState(0),[l,p]=h.useState(!1),c=a==null?void 0:a.user.id,{data:s,isLoading:o}=pe(c),{data:d,isLoading:H}=fe(c),{data:x,isLoading:K,error:_}=je(c,r,F,l),w=(x==null?void 0:x.entries)??[],U=(x==null?void 0:x.totalCount)??0,u=(s==null?void 0:s.monthly_credits)??0,P=(d==null?void 0:d.current_balance)??0,S=u>0?Math.max(u-P,0):0,I=u>0?Math.min(S/u*100,100):0;j(s==null?void 0:s.current_period_end);const X=s!=null&&s.current_period_start&&(s!=null&&s.current_period_end)?`${j(s.current_period_start)} → ${j(s.current_period_end)}`:t("billing:subscriptionCard.noSubscription"),z=Math.max(Math.ceil(U/F),1),J=r+1<z;return h.useEffect(()=>{l&&i(0)},[l]),e.jsxs("div",{children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-fg",children:t("billing:title","Subscription & Credits")}),e.jsx("p",{className:"text-muted mt-1",children:t("billing:subtitle","Track your plan, monthly allowance, and usage history.")})]}),e.jsx("div",{className:"mt-6 space-y-6",children:e.jsxs("div",{className:"grid gap-6 md:grid-cols-2",children:[e.jsxs(L,{children:[e.jsx(T,{children:e.jsx(M,{children:t("billing:subscriptionCard.title","Subscription")})}),e.jsx($,{className:"space-y-4",children:o?e.jsx("p",{className:"text-muted text-sm",children:t("common:loading")}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted",children:t("billing:subscriptionCard.plan","Current plan")}),e.jsx("p",{className:"text-lg font-semibold text-fg",children:(s==null?void 0:s.plan_name)??t("billing:subscriptionCard.noSubscription","No active subscription")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-sm text-muted",children:t("billing:subscriptionCard.status","Status")}),e.jsx(D,{variant:"outline",children:s!=null&&s.status?t(`billing:status.${s.status}`,{defaultValue:s.status}):t("billing:status.inactive")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted",children:t("billing:subscriptionCard.monthlyAllowance","Monthly allowance")}),e.jsx("p",{className:"text-lg font-semibold text-fg",children:u.toLocaleString()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted",children:t("billing:subscriptionCard.period","Current period")}),e.jsx("p",{className:"text-base text-fg",children:X})]}),e.jsx("p",{className:"text-xs text-muted",children:t("billing:subscriptionCard.resetNote","Credits reset on the 1st of every month at 00:00 UTC.")})]})})]}),e.jsxs(L,{children:[e.jsx(T,{children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx(M,{children:t("billing:creditsCard.title","Credits")}),e.jsxs(te,{open:l,onOpenChange:p,children:[e.jsx(se,{asChild:!0,children:e.jsx(f,{variant:"outline",size:"sm",children:t("billing:ledger.viewDetails","View details")})}),e.jsxs(ae,{className:"max-w-5xl max-h-[80vh] overflow-y-auto",children:[e.jsx(re,{children:e.jsx(le,{children:t("billing:ledger.title","Credit usage history")})}),K?e.jsx("p",{className:"text-muted text-sm",children:t("common:loading")}):_?e.jsx("p",{className:"text-sm text-destructive",children:_.message}):w.length===0?e.jsx("p",{className:"text-muted text-sm",children:t("billing:ledger.empty","No credit activity yet.")}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ie,{children:[e.jsx(ne,{children:e.jsxs(E,{children:[e.jsx(m,{children:t("billing:ledger.columns.date","Date")}),e.jsx(m,{children:t("billing:ledger.columns.type","Type")}),e.jsx(m,{children:t("billing:ledger.columns.delta","Delta")}),e.jsx(m,{children:t("billing:ledger.columns.feature","Feature")}),e.jsx(m,{children:t("billing:ledger.columns.description","Description")}),e.jsx(m,{className:"text-right",children:t("billing:ledger.columns.balance","Balance after")})]})}),e.jsx(de,{children:w.map(n=>e.jsxs(E,{children:[e.jsx(g,{children:j(n.created_at)}),e.jsx(g,{children:t(`billing:entries.${n.entry_type}`,{defaultValue:n.entry_type})}),e.jsx(g,{className:n.delta>=0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400",children:n.delta>=0?`+${n.delta}`:n.delta}),e.jsx(g,{children:n.feature_key??"—"}),e.jsx(g,{children:n.description??"—"}),e.jsx(g,{className:"text-right",children:n.balance_after.toLocaleString()})]},n.id))})]})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(f,{variant:"outline",size:"sm",onClick:()=>i(n=>Math.max(n-1,0)),disabled:r===0,children:t("billing:ledger.prev","Previous")}),e.jsx("span",{className:"text-sm text-muted",children:t("billing:ledger.pageLabel",{defaultValue:"Page {{page}}",page:r+1})}),e.jsx(f,{variant:"outline",size:"sm",onClick:()=>i(n=>n+1),disabled:!J,children:t("billing:ledger.next","Next")})]})]})]})]})]})}),e.jsx($,{className:"space-y-4",children:H?e.jsx("p",{className:"text-muted text-sm",children:t("common:loading")}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted",children:t("billing:creditsCard.currentBalance","Current balance")}),e.jsx("p",{className:"text-3xl font-bold text-fg",children:P.toLocaleString()})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:e.jsxs(f,{disabled:!0,variant:"secondary",className:"gap-2","aria-disabled":!0,children:[t("billing:creditsCard.buyCredits","Buy credits"),e.jsx(D,{variant:"outline",children:t("billing:creditsCard.soon","Soon")})]})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between text-sm text-muted",children:[e.jsx("span",{children:t("billing:creditsCard.usageThisMonth","Usage this month")}),u>0&&e.jsx("span",{children:t("billing:creditsCard.progressLabel",{defaultValue:"{{used}} / {{total}}",used:S.toLocaleString(),total:u.toLocaleString()})})]}),e.jsx(W,{value:I,className:"mt-2"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-muted",children:t("billing:creditsCard.lifetimeGranted","Lifetime granted")}),e.jsx("p",{className:"text-fg font-semibold",children:((d==null?void 0:d.lifetime_granted)??0).toLocaleString()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted",children:t("billing:creditsCard.lifetimeSpent","Lifetime spent")}),e.jsx("p",{className:"text-fg font-semibold",children:((d==null?void 0:d.lifetime_spent)??0).toLocaleString()})]})]})]})})]})]})})]})}export{ye as default};
